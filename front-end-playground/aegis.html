<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Web 监控实现原理 | 个人主页</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/images/photo.jpg">
    <link rel="manifest" href="/images/photo.jpg">
    <link rel="apple-touch-icon" href="/images/photo.jpg">
    <meta name="description" content="我的个人网站">
    <meta http-quiv="pragma" cotent="no-cache">
    <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
    <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.e6d790d2.js" as="script"><link rel="preload" href="/assets/js/2.670a8c78.js" as="script"><link rel="preload" href="/assets/js/1.71926bfe.js" as="script"><link rel="preload" href="/assets/js/52.5b2e9eb6.js" as="script"><link rel="prefetch" href="/assets/js/10.66b9053d.js"><link rel="prefetch" href="/assets/js/11.04545941.js"><link rel="prefetch" href="/assets/js/12.1bdea263.js"><link rel="prefetch" href="/assets/js/13.9426da25.js"><link rel="prefetch" href="/assets/js/14.856c1518.js"><link rel="prefetch" href="/assets/js/15.b360c35b.js"><link rel="prefetch" href="/assets/js/16.e925b239.js"><link rel="prefetch" href="/assets/js/17.5b873df7.js"><link rel="prefetch" href="/assets/js/18.4c170722.js"><link rel="prefetch" href="/assets/js/19.a45744ea.js"><link rel="prefetch" href="/assets/js/20.e4646aa0.js"><link rel="prefetch" href="/assets/js/21.a45f0526.js"><link rel="prefetch" href="/assets/js/22.49faaeca.js"><link rel="prefetch" href="/assets/js/23.c2b62dee.js"><link rel="prefetch" href="/assets/js/24.637d604b.js"><link rel="prefetch" href="/assets/js/25.1370aa75.js"><link rel="prefetch" href="/assets/js/26.254ee0fc.js"><link rel="prefetch" href="/assets/js/27.09790146.js"><link rel="prefetch" href="/assets/js/28.7e5b1948.js"><link rel="prefetch" href="/assets/js/29.fce874c1.js"><link rel="prefetch" href="/assets/js/3.4db2e19a.js"><link rel="prefetch" href="/assets/js/30.a2fe8eb2.js"><link rel="prefetch" href="/assets/js/31.162506d4.js"><link rel="prefetch" href="/assets/js/32.3cde0674.js"><link rel="prefetch" href="/assets/js/33.d7d3d255.js"><link rel="prefetch" href="/assets/js/34.70bab86a.js"><link rel="prefetch" href="/assets/js/35.e25e2604.js"><link rel="prefetch" href="/assets/js/36.b5fada05.js"><link rel="prefetch" href="/assets/js/37.e2f9bc23.js"><link rel="prefetch" href="/assets/js/38.24d3a67d.js"><link rel="prefetch" href="/assets/js/39.2b6a21e0.js"><link rel="prefetch" href="/assets/js/4.45665f8a.js"><link rel="prefetch" href="/assets/js/40.d406595a.js"><link rel="prefetch" href="/assets/js/41.917cf6ec.js"><link rel="prefetch" href="/assets/js/42.2a915dbf.js"><link rel="prefetch" href="/assets/js/43.06d233c4.js"><link rel="prefetch" href="/assets/js/44.f41cf9e5.js"><link rel="prefetch" href="/assets/js/45.2f577289.js"><link rel="prefetch" href="/assets/js/46.69e142ff.js"><link rel="prefetch" href="/assets/js/47.6967f1f2.js"><link rel="prefetch" href="/assets/js/48.c42a0925.js"><link rel="prefetch" href="/assets/js/49.396ed3db.js"><link rel="prefetch" href="/assets/js/5.b31b942f.js"><link rel="prefetch" href="/assets/js/50.f9fa87b4.js"><link rel="prefetch" href="/assets/js/51.f5150e72.js"><link rel="prefetch" href="/assets/js/53.775f3eb1.js"><link rel="prefetch" href="/assets/js/54.af0c3dd1.js"><link rel="prefetch" href="/assets/js/55.062c9831.js"><link rel="prefetch" href="/assets/js/56.3228b669.js"><link rel="prefetch" href="/assets/js/57.3e194052.js"><link rel="prefetch" href="/assets/js/58.0fac8851.js"><link rel="prefetch" href="/assets/js/59.4a2921bc.js"><link rel="prefetch" href="/assets/js/6.4910e764.js"><link rel="prefetch" href="/assets/js/60.aaff0e8d.js"><link rel="prefetch" href="/assets/js/61.4094ca3e.js"><link rel="prefetch" href="/assets/js/62.a4d3e4b0.js"><link rel="prefetch" href="/assets/js/63.90c7781d.js"><link rel="prefetch" href="/assets/js/64.9f28672a.js"><link rel="prefetch" href="/assets/js/65.82d99a34.js"><link rel="prefetch" href="/assets/js/66.4b1a7c79.js"><link rel="prefetch" href="/assets/js/67.cde2a4b8.js"><link rel="prefetch" href="/assets/js/68.7b2ca4b4.js"><link rel="prefetch" href="/assets/js/69.3f6a7106.js"><link rel="prefetch" href="/assets/js/7.c5640ac7.js"><link rel="prefetch" href="/assets/js/70.97a2a772.js"><link rel="prefetch" href="/assets/js/71.35881c3b.js"><link rel="prefetch" href="/assets/js/72.25b350dc.js"><link rel="prefetch" href="/assets/js/73.11c7d3f8.js"><link rel="prefetch" href="/assets/js/74.920a6416.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/accumulate/prepare/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div><div class="nav-item"><a href="/network/guide/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/miniprogram/" class="nav-link">
  小程序
</a></div><div class="nav-item"><a href="/typescript/" class="nav-link">
  typescript
</a></div><div class="nav-item"><a href="/front-end-playground/" class="nav-link router-link-active">
  前端的进击
</a></div><div class="nav-item"><a href="/others/" class="nav-link">
  其他
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/accumulate/prepare/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div><div class="nav-item"><a href="/network/guide/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/miniprogram/" class="nav-link">
  小程序
</a></div><div class="nav-item"><a href="/typescript/" class="nav-link">
  typescript
</a></div><div class="nav-item"><a href="/front-end-playground/" class="nav-link router-link-active">
  前端的进击
</a></div><div class="nav-item"><a href="/others/" class="nav-link">
  其他
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front-end-playground/performance/optimize.html" class="sidebar-link">归纳总结的点</a></li><li><a href="/front-end-playground/exception.html" class="sidebar-link">前端监控可以帮我们解决什么问题</a></li><li><a href="/front-end-playground/react.html" class="sidebar-link">react</a></li><li><a href="/front-end-playground/aegis.html" aria-current="page" class="active sidebar-link">Web 监控实现原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#错误监控" class="sidebar-link">错误监控</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#js-执行错误" class="sidebar-link">JS 执行错误</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#promise-执行错误" class="sidebar-link">promise 执行错误</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#资源加载失败" class="sidebar-link">资源加载失败</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#接口请求异常" class="sidebar-link">接口请求异常</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#性能监控" class="sidebar-link">性能监控</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#页面测速" class="sidebar-link">页面测速</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#接口测速" class="sidebar-link">接口测速</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#资源测速" class="sidebar-link">资源测速</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#web-vitals" class="sidebar-link">Web Vitals</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#sdk-架构设计" class="sidebar-link">SDK 架构设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#sdk-如何方便的进行业务拓展和定制" class="sidebar-link">SDK 如何方便的进行业务拓展和定制？</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#微内核架构" class="sidebar-link">微内核架构</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#定制化" class="sidebar-link">定制化</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#sdk-如何实现异常隔离以及上报" class="sidebar-link">SDK 如何实现异常隔离以及上报</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#sdk-如何实现服务端时间的校对" class="sidebar-link">SDK 如何实现服务端时间的校对</a></li><li class="sidebar-sub-header"><a href="/front-end-playground/aegis.html#sdk-如何实现会话级别的错误上报去重" class="sidebar-link">SDK 如何实现会话级别的错误上报去重</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="web-监控实现原理"><a href="#web-监控实现原理" class="header-anchor">#</a> Web 监控实现原理</h1> <p>参考链接 https://juejin.cn/post/7108660942686126093</p> <p>实现无侵入式监控，主要有 3 种思路</p> <ul><li>全局事件监听</li> <li>浏览器 API 劫持</li> <li>浏览器 API 调用</li></ul> <p>需要关注的点，拆分如下</p> <ul><li>页面的性能情况：包括各阶段加载耗时，一些关键性的用户体验指标等</li> <li>用户的行为情况：包括PV、UV、访问来路，路由跳转等</li> <li>接口的调用情况：通过http访问的外部接口的成功率、耗时情况等</li> <li>页面的稳定情况：各种前端异常等</li> <li>数据上报及优化：如何将监控捕获到的数据优雅的上报</li></ul> <h2 id="错误监控"><a href="#错误监控" class="header-anchor">#</a> 错误监控</h2> <p>错误监控包括<code>JS执行错误</code>，<code>Promise执行错误</code>，<code>资源加载失败</code>和<code>接口请求异常</code>4个部分。</p> <h3 id="js-执行错误"><a href="#js-执行错误" class="header-anchor">#</a> <code>JS</code> 执行错误</h3> <p>要捕获 JS 的运行时错误，只需要监听 <code>onerror</code> 事件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">stringify</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> @ (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">stringify</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span>
  <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)
  \n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">stringify</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token literal-property property">level</span><span class="token operator">:</span> LogType<span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">,</span>
  orgError<span class="token operator">?.</span><span class="token function">call</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 详细参数</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获到错误:'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 阻止默认处理</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>我们会将错误的文件和行号列号一起上报，后续查日志的时候，就能结合 sourcemap 定位错误在源码的位置了，背后会用到 source-map 这个工具</p> <h3 id="promise-执行错误"><a href="#promise-执行错误" class="header-anchor">#</a> <code>promise</code> 执行错误</h3> <p>要捕获没有被用户 <code>catch</code> 的 <code>promise</code> 错误，可以通过监听 <code>unhandledrejection</code> 事件实现。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unhandledrejection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">event</span><span class="token operator">:</span> PromiseRejectionEvent</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> reason <span class="token operator">=</span> event <span class="token operator">&amp;&amp;</span> <span class="token function">stringify</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">PROMISE_ERROR: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token literal-property property">level</span><span class="token operator">:</span> LogType<span class="token punctuation">.</span><span class="token constant">PROMISE_ERROR</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="资源加载失败"><a href="#资源加载失败" class="header-anchor">#</a> 资源加载失败</h3> <blockquote><p>通过<code>addEventListener</code>添加的<code>error</code>事件监听器和<code>window.error</code>的主要区别是，window.onerror 能捕获更广泛的错误类型，包括语法错误、运行时错误等，而通过addEventListener监听的error事件主要用于捕获资源加载相关的错误。</p></blockquote> <ul><li>更具体的错误处理: 通过<code>addEventListener</code>添加的<code>error</code>事件监听器主要是用来捕获特定于文档的错误,尤其是资源加载错误，（如图像、视频、脚本文件等无法加载时），这不会捕获<code>JavaScript</code>的运行时错误。</li> <li>事件对象: 监听器接收一个事件对象，该对象可以提供关于错误的一些上下文，例如错误发生的具体元素等。</li> <li>冒泡与捕获: 这种方式支持事件的冒泡和捕获机制，允许你在错误到达一个元素之前或之后进行处理。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">event</span><span class="token operator">:</span> Event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> target <span class="token operator">=</span> event<span class="token operator">?.</span>target <span class="token operator">||</span> event<span class="token operator">?.</span>srcElement<span class="token punctuation">;</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> target<span class="token punctuation">.</span>src <span class="token operator">||</span> target<span class="token punctuation">.</span>href<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> tagName <span class="token punctuation">}</span> <span class="token operator">=</span> target<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> url <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> tagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> log <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tagName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> load fail: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">level</span><span class="token operator">:</span> LogType<span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 先根据文件后缀简单判断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span>level <span class="token operator">=</span> LogType<span class="token punctuation">.</span><span class="token constant">SCRIPT_ERROR</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span>level <span class="token operator">=</span> LogType<span class="token punctuation">.</span><span class="token constant">CSS_ERROR</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 再根据文件类型判断</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'script'</span><span class="token operator">:</span>
          log<span class="token punctuation">.</span>level <span class="token operator">=</span> LogType<span class="token punctuation">.</span><span class="token constant">SCRIPT_ERROR</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'link'</span><span class="token operator">:</span>
          log<span class="token punctuation">.</span>level <span class="token operator">=</span> LogType<span class="token punctuation">.</span><span class="token constant">CSS_ERROR</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'img'</span><span class="token operator">:</span>
          log<span class="token punctuation">.</span>level <span class="token operator">=</span> LogType<span class="token punctuation">.</span><span class="token constant">IMAGE_ERROR</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'audio'</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token string">'video'</span><span class="token operator">:</span>
          log<span class="token punctuation">.</span>level <span class="token operator">=</span> LogType<span class="token punctuation">.</span><span class="token constant">MEDIA_ERROR</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="接口请求异常"><a href="#接口请求异常" class="header-anchor">#</a> 接口请求异常</h3> <p>要获取接口请求的异常，需要劫持 <code>XMLHttpRequest</code> 和 <code>fetch</code> 这 2 个浏览器 API，在请求返回的时候判断是否有错误</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * XMLHttpRequest 劫持
 */</span>
xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  xhr<span class="token punctuation">.</span>failType <span class="token operator">=</span> <span class="token string">'timeout'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  xhr<span class="token punctuation">.</span>failType <span class="token operator">=</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'abort'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  xhr<span class="token punctuation">.</span>failType <span class="token operator">=</span> <span class="token string">'abort'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'loadend'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>failType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    type <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>failType<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// status 为 0 或者 undefined</span>
    type <span class="token operator">=</span> <span class="token string">'failed'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    type <span class="token operator">=</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">AJAX_ERROR: request </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * fetch 劫持
 */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="性能监控"><a href="#性能监控" class="header-anchor">#</a> 性能监控</h2> <p>性能监控包含页面测速、接口测速、资源测速、Web Vitals</p> <h3 id="页面测速"><a href="#页面测速" class="header-anchor">#</a> 页面测速</h3> <p>九大指标</p> <ul><li>dns查询</li> <li>tcp链接</li> <li>ssl建连</li> <li>请求响应</li> <li>内容传输</li> <li>DOM解析</li> <li>资源加载</li> <li>首屏耗时</li> <li>页面完成加载时间</li></ul> <p>其中前面 <code>7</code> 个指标都是可以直接调用 <code>Performance API</code> 算出来的，会涉及到下面这些指标的计算</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> t<span class="token operator">:</span> PerformanceTiming <span class="token operator">=</span> performance<span class="token punctuation">.</span>timing
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">{</span>
  dnsLookup<span class="token operator">:</span> t<span class="token punctuation">.</span>domainLookUpEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>domainLookUpStart<span class="token punctuation">,</span>
  tcp<span class="token operator">:</span> t<span class="token punctuation">.</span>contentEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>contentStart<span class="token punctuation">,</span>
  ssl<span class="token operator">:</span> t<span class="token punctuation">.</span>secureConnectionStart <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> t<span class="token punctuation">.</span>requestStart <span class="token operator">-</span> secureConnectionStart<span class="token punctuation">,</span>
  ttfb<span class="token operator">:</span> t<span class="token punctuation">.</span>responseStart <span class="token operator">-</span> t<span class="token punctuation">.</span>requestStart<span class="token punctuation">,</span> <span class="token comment">// 请求响应耗时</span>
  contentDownload<span class="token operator">:</span> t<span class="token punctuation">.</span>responseEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>responseStart <span class="token comment">// 内容传输</span>
  domParse<span class="token operator">:</span> t<span class="token punctuation">.</span>domInteractive <span class="token operator">-</span> t<span class="token punctuation">.</span>domLoading <span class="token comment">// dom解析</span>
  resourceDownload<span class="token operator">:</span> t<span class="token punctuation">.</span>loadEventStart <span class="token operator">-</span> t<span class="token punctuation">.</span>domInteractive <span class="token comment">// 资源加载</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="首屏耗时"><a href="#首屏耗时" class="header-anchor">#</a> 首屏耗时</h4> <p>默认的算法是在 3 秒内监听首屏区域内元素的变化，记录元素的变化时间和包含的子节点数量，取子节点数最多的元素的变化时间为首屏时间。假设发生了 2 次变化，并且变化的元素都在首屏区域内：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> change1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">roots</span><span class="token operator">:</span> <span class="token punctuation">[</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">rootsDomNum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">time</span><span class="token operator">:</span> <span class="token number">2860</span> <span class="token comment">// 通过 performance.now() 获取</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> change2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">roots</span><span class="token operator">:</span> <span class="token punctuation">[</span>e3<span class="token punctuation">,</span> e4<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">rootsDomNum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">time</span><span class="token operator">:</span> <span class="token number">3998</span> <span class="token comment">// 通过 performance.now() 获取</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>子节点数量最多的是 e1，对应的时间是 2.86 秒，我们就以这个时间来作为首屏时间。 监听元素的变化使用了 MutationObserver：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> observeDom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token parameter">mutations</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> change <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">roots</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">rootsDomNum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">time</span><span class="token operator">:</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  mutations<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">mutation</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    mutation<span class="token punctuation">.</span>addedNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ele</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 标识了首屏关键元素，只记录关键元素的变化时间</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token string">'FIRST-SCREEN-TIMING'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>markDoms<span class="token punctuation">,</span> <span class="token punctuation">[</span>change<span class="token punctuation">.</span>time<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          markDoms<span class="token punctuation">[</span>change<span class="token punctuation">.</span>time<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        markDoms<span class="token punctuation">[</span>change<span class="token punctuation">.</span>time<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 默认首屏算法</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token string">'IGNORE-FIRST-SCREEN-TIMING'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        change<span class="token punctuation">.</span>roots<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
        change<span class="token punctuation">.</span>rootsDomNum<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">walkAndCount</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  change<span class="token punctuation">.</span>roots<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> changeList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>change<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
observeDom<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">subtree</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>当用户给元素添加 <code>first-screen-timing</code> 属性的时候,我们会记录这个元素的变化时间，3 秒后取变化时间的最大值作为首屏时间。 在使用默认算法的时候，可以为元素添加属性 <code>ignore-first-screen-timing</code> 来忽略节点的变化统计。</p> <h3 id="接口测速"><a href="#接口测速" class="header-anchor">#</a> 接口测速</h3> <h4 id="劫持-xmlhttprequest-的-send-方法"><a href="#劫持-xmlhttprequest-的-send-方法" class="header-anchor">#</a> 劫持 <code>XMLHttpRequest</code> 的 <code>send</code> 方法</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function-variable function">send</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">xhr<span class="token punctuation">,</span> body</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> sendTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  xhr<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'loadend'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> xhr<span class="token punctuation">.</span>Url<span class="token punctuation">;</span>
    <span class="token keyword">const</span> duration <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> sendTime<span class="token punctuation">;</span>
    <span class="token keyword">const</span> speedLog <span class="token operator">=</span> <span class="token punctuation">{</span>
      url<span class="token punctuation">,</span>
      <span class="token literal-property property">isHttps</span><span class="token operator">:</span> <span class="token function">urlIsHttps</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> xhr<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> xhr<span class="token punctuation">.</span>Method <span class="token operator">||</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'fetch'</span><span class="token punctuation">,</span>
      duration<span class="token punctuation">,</span>
      <span class="token literal-property property">payload</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">PayloadXHR</span><span class="token punctuation">(</span>xhr<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>\console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>speedLog<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="fetch-劫持"><a href="#fetch-劫持" class="header-anchor">#</a> <code>fetch</code> 劫持</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> originFetch <span class="token operator">=</span> window<span class="token punctuation">.</span>fetch<span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function-variable function">fetch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">FakeFetch</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">url</span><span class="token operator">:</span> RequestInfo<span class="token punctuation">,</span> fetchOption <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> sendTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">originFetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> fetchOption<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> duration <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> sendTime<span class="token punctuation">;</span>
      <span class="token keyword">const</span> speedLog <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">url</span><span class="token operator">:</span> res<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
        <span class="token literal-property property">isHttps</span><span class="token operator">:</span> <span class="token function">urlIsHttps</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> option<span class="token operator">?.</span>method <span class="token operator">||</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
        duration<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'fetch'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">status</span><span class="token operator">:</span> res<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>speedLog<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="资源测速"><a href="#资源测速" class="header-anchor">#</a> 资源测速</h3> <p>资源测速是通过<code>PerformanceObserver</code>来实现的</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> entries <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> entries<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> duration <span class="token operator">=</span> entry<span class="token punctuation">.</span>duration<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">entryTypes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'resource'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="web-vitals"><a href="#web-vitals" class="header-anchor">#</a> Web Vitals</h3> <p><code>Web Vitals</code> 的获取方式比较简单，直接使用 <code>google</code> 提供的 <code>npm</code> 包就能获取到，我们就简单归类为浏览器 <code>API</code> 的直接调用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>getFCP<span class="token punctuation">,</span> getLCP<span class="token punctuation">,</span> getFID<span class="token punctuation">,</span> getCLS<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'web-vitals/base'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>LCP
<ul><li>衡量用户在打开页面后，最大的内容元素（图片、视频、大的文本块），加载完成所需的时间</li></ul></li> <li>FID
<ul><li><code>FID</code>量度的是用户首次与页面交互（如点击链接、按钮等）到浏览器实际能够响应该交互的时间。一个好的<code>FID</code>度量应该在<code>100</code>毫秒或更短。</li></ul></li> <li>CLS
<ul><li><code>CLS</code>是衡量视觉稳定性的指标，它记录了视觉页面内容在加载期间发生意外布局偏移的程度。理想的<code>CLS</code>得分应该是<code>0.1</code>或更低。</li></ul></li></ul> <h2 id="sdk-架构设计"><a href="#sdk-架构设计" class="header-anchor">#</a> SDK 架构设计</h2> <p>为支持多平台、可拓展、可插拔的特点，整体SDK的架构设计是 内核+插件 的插件式设计；每个 SDK 首先继承于平台无关的 Core 层代码。然后在自身SDK中，初始化内核实例和插件；
<img src="/images/sdk.png" alt=""></p> <ul><li>我们用 Core 来管理 SDK 内与平台无关的一些代码，比如一些公共方法(生成mid方法、格式化)；</li> <li>然后每个平台单独一个 SDK；去继承 core 的类；SDK 内自己管理SDK特有的核心方法逻辑，比如上报、参数初始化；</li> <li>最后就是 Plugins 插件，每个SDK都是由 内核+插件 组成的，我们将所有的插件功能，比如性能监控、错误监控都抽离成插件；</li></ul> <p>这样子进行 SDK 的设计有很多好处：</p> <ul><li>每个平台分开打包，每个包的体积会大大缩小；</li> <li>代码的逻辑更加清晰自恰</li></ul> <p>最后打包上线时，我们通过修改 build 的脚本，对 packages 文件夹下的每个平台都单独打一个包，并且分开上传到 npm 平台；</p> <h3 id="sdk-如何方便的进行业务拓展和定制"><a href="#sdk-如何方便的进行业务拓展和定制" class="header-anchor">#</a> SDK 如何方便的进行业务拓展和定制？</h3> <h3 id="微内核架构"><a href="#微内核架构" class="header-anchor">#</a> 微内核架构</h3> <ol><li>为了提高代码的可维护性和扩展性，借鉴微内核架构来组织我们的代码，实现了控制逻辑与业务逻辑的解耦。</li> <li>控制逻辑主要由内核来实现，功能包括生命周期管理、插件管理、上报策略管理和配置管理。</li> <li>而具体的业务逻辑是由各个插件来实现，例如错误监控、资源测速和接口测速等，每一个都是独立的插件。</li> <li>当需要添加一个新功能的时候，只需要新增一个插件就可以了，其它代码都不会受影响。
<img src="/images/plugin.png" alt=""></li></ol> <h4 id="业务扩展"><a href="#业务扩展" class="header-anchor">#</a> 业务扩展</h4> <ul><li>内核里是SDK内的公共逻辑或者基础逻辑；比如数据格式化和数据上报是底下插件都要用到的公共逻辑；而配置初始化是SDK运行的一个基础逻辑；</li> <li>插件里是SDK的上层拓展业务，比如说监听js错误、监听promise错误，每一个小功能都是一个插件；</li> <li>内核和插件一起组成了 SDK实例 Instance，最后暴露给客户端使用；</li></ul> <h3 id="定制化"><a href="#定制化" class="header-anchor">#</a> 定制化</h3> <p>插件里的功能，都是使用与否不影响整个SDK运行的，所以我们可以自由的让用户对插件里的功能进行定制化，决定哪个监控功能启用、哪个监控功能不启用等等</p> <h3 id="sdk-如何实现异常隔离以及上报"><a href="#sdk-如何实现异常隔离以及上报" class="header-anchor">#</a> SDK 如何实现异常隔离以及上报</h3> <p>而如果因为监控SDK报错，导致整个应用主业务流程被中断，这是我们不能够接收的；我们无法保证我们的 SDK 不出现错误，那么假如万一SDK本身报错了，我们就需要它不会去影响主业务流程的运行；</p> <p>最简单粗暴的方法就是把整个 SDK 都用 try catch 包裹起来，那么这样子即使出现了错误，也会被拦截在我们的 catch 里面；</p> <ul><li>我们只能获取到一个报错的信息，但是我们无法得知报错的位置、插件；</li> <li>我们没有将其上报，我们无法感知到 SDK 产生了错误</li> <li>我们没法获取 SDK 出错的一个环境数据</li></ul> <p>我们就需要一个相对优雅的一个异常隔离+上报机制，回想我们上文的架构：内核+插件的形式；我们对每一个插件模块，都单独的用trycatch包裹起来，然后当抛出错误的时候，进行数据的封装、上报；</p> <h3 id="sdk-如何实现服务端时间的校对"><a href="#sdk-如何实现服务端时间的校对" class="header-anchor">#</a> SDK 如何实现服务端时间的校对</h3> <p>http响应头 上有一个字段 Date；它的值是服务端发送资源时的服务器时间，我们可以在初始化SDK的时候，发送一个简单的请求给上报服务器，获取返回的 Date 值后计算 Diff差值 存在本地；</p> <p>提供一个 公共API，来提供一个时间校对的服务，让本地的时间 比较趋近于 服务端的真实时间；（只是比较趋近的原因是：还会有一个单程传输耗时的误差）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> diff <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">diffTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">date</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> serverDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> inDiff <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> serverDate<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>diff <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> diff <span class="token operator">&gt;</span> inDiff<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    diff <span class="token operator">=</span> inDiff<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="sdk-如何实现会话级别的错误上报去重"><a href="#sdk-如何实现会话级别的错误上报去重" class="header-anchor">#</a> SDK 如何实现会话级别的错误上报去重</h3> <p>我们需要理清一个概念，我们可以认为</p> <ul><li>在用户的一次会话中，如果产生了同一个错误，那么将这同一个错误上报多次是没有意义的；</li> <li>在用户的不同会话中，如果产生了同一个错误，那么将不同会话中产生的错误进行上报是有意义的；</li></ul> <p>为什么有上面的结论呢？理由很简单:</p> <ul><li>在用户的同一次会话中，如果点击一个按钮出现了错误，那么再次点击同一个按钮，必定会出现同一个错误，而这出现的多次错误，影响的是同一个用户、同一次访问；所以将其全部上报是没有意义的；</li> <li>而在同一个用户的不同会话中，如果出现了同一个错误，那么这不同会话里的错误进行上报就显得有意义了；</li></ul> <p>生成 错误mid</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 对每一个错误详情，生成一串编码</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getErrorUid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">input</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> window<span class="token punctuation">.</span><span class="token function">btoa</span><span class="token punctuation">(</span><span class="token function">unescape</span><span class="token punctuation">(</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>所以说我们传入的参数，是 错误信息、错误行号、错误列号、错误文件等可能的关键信息的一个集合，这样保证了产生在同一个地方的错误，生成的 错误mid 都是相等的；这样子，我们才能在错误上报的入口函数里，做上报去重；</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/22/2024, 7:39:51 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/front-end-playground/react.html" class="prev">
        react
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e6d790d2.js" defer></script><script src="/assets/js/2.670a8c78.js" defer></script><script src="/assets/js/1.71926bfe.js" defer></script><script src="/assets/js/52.5b2e9eb6.js" defer></script>
  </body>
</html>
